<!DOCTYPE html>
<html lang="en">
<head>
<meta name="generator" content="Bluefish 2.2.6" >
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>World Map</title>
<meta name="description" content="GeoTweeter Earth">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div id="vis"></div>

<script src="d3.v3.min.js" type="text/javascript">
</script><script src="countries.js" type="text/javascript">
</script><script type="text/javascript">
console.log('init');
var summary;
var req = new XMLHttpRequest();
req.open("GET", "/summary", true);
req.addEventListener("load", function() {
	summary = JSON.parse(req.responseText);
	console.log("loaded world summary");
	doIt(c);
});
req.send(null);

function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

var width = 700;
var height = 700;

var projection = d3.geo.azimuthalEquidistant().scale(1).translate([0,0]);
var path = d3.geo.path().projection(projection);

var vis = d3.select("#vis").append("svg").attr("width", width).attr("height", height);



function doIt(countryGeo) {
	console.log('builing map');
	var bounds = path.bounds(countryGeo);
	var s = 0.95 / Math.max((bounds[1][0] - bounds[0][0]) / width, (bounds[1][1] - bounds[0][1]) / height);
	var t = [(width - s * (bounds[1][0] + bounds[0][0])) / 2, (height - s * (bounds[1][1] + bounds[0][1])) / 2];

	projection
		.scale(s)
      .translate(t);

      //Diagonal Hatch for no HeatMap
	vis.append('defs')
		.append('pattern')
			.attr('id', 'diagonalHatch')
			.attr('patternUnits', 'userSpaceOnUse')
			.attr('width', 4)
			.attr('height', 4)
		.append('path')
			.attr('d', 'M-1,1 l2,-2 M0,4 l4,-4 M3,5 l2,-2')
			.attr('stroke', '#222')
			.attr('stroke-width', 1);

	vis.append("g")
		.attr("class", "countries" )
		.attr("title", "Countries of the World")
		.selectAll("path")
      .data(countryGeo.features)
			.enter().append("path")
				.attr("d", path)
				.attr("stroke", "#222")
				.attr("fill", function(d) { return (summary[d.properties["ADMIN"]] ? summary[d.properties["ADMIN"]].heat : "url(#diagonalHatch)");} )
			.on("click", function(d) { window.location.href="country.html?country="+d.properties["ADMIN"]; })
			.append("svg:title")
				.text(function(d, i) {
					if(summary[d.properties["ADMIN"]]) {
						return d.properties["ADMIN"]+" "+numberWithCommas(summary[d.properties["ADMIN"]].total) +" of "+numberWithCommas(summary.total)+" tweets";
					} else {
						return d.properties["ADMIN"];
					}
				});
	console.log("map svg done");
  };
</script>
</body>
</html>
